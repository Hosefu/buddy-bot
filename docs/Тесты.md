Ниже ― максимально полный **чек‑лист автотестов** для указанного API.  
Формат: **[ID] Краткое название — Что проверяем**.  
ID уникален в рамках секции; его хватит, чтобы в другой системе связать тест с реализацией.  

### Правила именования тестов

- Имя функции начинается с `test_` и включает идентификатор из таблицы (например `AUTH_01`).
- Для сквозных сценариев используется префикс `E2E_`.
- Такой подход позволяет видеть ID теста в отчётах `pytest`.

Если логика одинакова для разных ролей/сущностей, достаточно одного теста с параметризацией.

---

## 1. Авторизация и аутентификация

|№|Тест|
|---|---|
|**AUTH‑01**|Telegram Login — успешная авторизация нового пользователя, корректный JWT в ответе|
|**AUTH‑02**|Telegram Login — успешная авторизация существующего `is_active=true` пользователя|
|**AUTH‑03**|Telegram Login — отказ при недействительной подписи данных Telegram|
|**AUTH‑04**|Telegram Login — отказ при отсутствии обязательных полей (id / hash)|
|**AUTH‑05**|Telegram Login — отказ, если пользователь помечен `is_active=false`|
|**AUTH‑06**|`/api/auth/me/` — 200 и корректный JSON при валидном токене|
|**AUTH‑07**|`/api/auth/me/` — 401 при отсутствии/просрочке токена|

---

## 2. RBAC (общие проверки доступа)

|№|Тест|
|---|---|
|**RBAC‑01**|Любой `/api/my/*` доступен для ролей _user_, _buddy_, _moderator_|
|**RBAC‑02**|Любой `/api/buddy/*` разрешён только _buddy_ и _moderator_|
|**RBAC‑03**|Любой `/api/admin/*` разрешён только _moderator_|
|**RBAC‑04**|Попытка доступа без нужной роли → 403|
|**RBAC‑05**|Несовпадение `user_id` (доступ к чужим личным данным) → 403|

---

## 3. “Мои данные”

| №         | Тест                                                                                |
| --------- | ----------------------------------------------------------------------------------- |
| **MY‑01** | `GET /api/my/flows/` — список только активных Flow, к которым пользователь назначен |
| **MY‑02** | `GET /api/my/progress/` — корректный агрегированный прогресс (percent)              |
| **MY‑03** | `GET /api/my/progress/{flow_id}/` — 200, если пользователь участвует, 404 иначе     |

---

## 4. Контент и прохождение

|№|Тест|
|---|---|
|**CNT‑01**|`GET /api/flows/{id}/` — детали доступны всем авторизованным|
|**CNT‑02**|`GET /api/flows/{id}/steps/` — отдаёт **только** доступные + текущий шаг|
|**CNT‑03**|Порядок `order` в ответе не нарушается|
|**CNT‑04**|`GET /api/articles/{id}/` — статья доступна вне флоу|
|**CNT‑05**|`POST /flows/{fid}/steps/{sid}/read/` — первый вызов → 201 и `article_read_at` заполняется|
|**CNT‑06**|Повторный `read` того же шага → 204 (idempotent)|
|**CNT‑07**|`GET task`/`GET quiz` до открытия шага → 403|
|**CNT‑08**|`GET task` после открытия → 200 и все поля задачи|
|**CNT‑09**|`POST quiz answer` — правильный ответ → 200, `is_correct=true` + прогресс обновлён|
|**CNT‑10**|`POST quiz answer` — неверный ответ → 200, `is_correct=false`|
|**CNT‑11**|После последнего правильного ответа квиза шаг переходит в `completed`, UserFlow двигается к следующему шагу|
|**CNT‑12**|Попытка отправить ответ на чужой квиз‑вопрос → 403|
|**CNT‑13**|Проверка `shuffle_questions/answers` — разный порядок в разных сессиях (тест генератором фикса)|

---

## 5. Business‑rules прогресса

|№|Тест|
|---|---|
|**PRG‑01**|Первый шаг доступен сразу при `UserFlow.status=in_progress`|
|**PRG‑02**|Второй шаг `is_accessible=false` пока первый не `completed`|
|**PRG‑03**|При завершении последнего шага `UserFlow.status` → `completed`, `completed_at` заполняется|
|**PRG‑04**|Если `status=paused`, все `steps.is_accessible` → false|
|**PRG‑05**|Попытка изменить прогресс в `paused` состоянии → 403|
|**PRG‑06**|`estimated_time_minutes` суммируется верно во вкладке прогресса|

---

## 6. Buddy — инициация флоу

|№|Тест|
|---|---|
|**B‑INIT‑01**|`GET /api/buddy/flows/` — только `is_active=true`|
|**B‑INIT‑02**|`GET /api/buddy/users/` — список всех активных пользователей|
|**B‑INIT‑03**|`POST start` с валидными `user_id` + дедлайном → 201, создаётся `UserFlow` + запись в `FlowAction`|
|**B‑INIT‑04**|`POST start` без `deadline` → 400|
|**B‑INIT‑05**|`POST start` для уже активного потока того же пользователя → 409|

---

## 7. Buddy — управление активными флоу

|№|Тест|
|---|---|
|**B‑MGMT‑01**|`GET /api/buddy/my-flows/` — только те, где текущий пользователь — buddy|
|**B‑MGMT‑02**|`GET /api/buddy/flow/{pid}` — подробный прогресс подопечного|
|**B‑MGMT‑03**|`POST pause` — переводит `UserFlow.status` в `paused`, фиксирует `paused_at` + `FlowAction`|
|**B‑MGMT‑04**|`POST resume` — восстанавливает статус, `FlowAction` пишется|
|**B‑MGMT‑05**|`DELETE flow` — удаляет `UserFlow`, пользователь теряет доступ; история сохраняется|
|**B‑MGMT‑06**|Buddy не может паузить чужой поток → 403|

---

## 8. Admin — управление пользователями

|№|Тест|
|---|---|
|**ADM‑USR‑01**|`GET /api/admin/users/` — пагинация, фильтры (`is_active`)|
|**ADM‑USR‑02**|`POST roles` — добавляет запись в `UserRole`, `is_active=true`|
|**ADM‑USR‑03**|`DELETE roles` — `is_active=false`, не физическое удаление|
|**ADM‑USR‑04**|Нельзя назначить несуществующую роль → 400|
|**ADM‑USR‑05**|Дублирование активной роли → 409|

---

## 9. Admin — CRUD Flow

|№|Тест|
|---|---|
|**ADM‑FLW‑01**|`GET /api/admin/flows/` — список, фильтр `is_active`|
|**ADM‑FLW‑02**|`POST flows` — создаёт Flow, все обязательные поля проверены|
|**ADM‑FLW‑03**|`PUT flows/{id}` — меняет `title/description`; `updated_at` обновляется|
|**ADM‑FLW‑04**|`DELETE flows/{id}` — каскадно отключает все `FlowStep.is_active`|
|**ADM‑FLW‑05**|Удаление активного потока с живыми `UserFlow` → 409|

---

## 10. Admin — CRUD FlowStep, Article, Task, Quiz

_(аналогичные тесты, показываю по одному на сущность — параметризовать)_

|№|Тест|
|---|---|
|**ADM‑STEP‑01**|`POST /flows/{fid}/steps/` — порядок `order` корректен (автоинкремент/явно)|
|**ADM‑ART‑01**|`POST /api/admin/articles/` — Markdown валидируется, `created_at` заполняется|
|**ADM‑TASK‑01**|`POST /steps/{sid}/task/` — кодовое слово != ""|
|**ADM‑QUIZ‑01**|`POST /steps/{sid}/quiz/` — `passing_score_percentage` ∈ 0‑100|

---

## 11. Admin — Quiz  детали

|№|Тест|
|---|---|
|**ADM‑QQ‑01**|В квизе ≤ 15 вопросов|
|**ADM‑QQ‑02**|`POST question` — `order` уникален в квизе|
|**ADM‑ANS‑01**|Вопрос содержит ровно 5 вариантов ответа|
|**ADM‑ANS‑02**|Одновременно ≥1 `is_correct=true`; сохранить → 400 иначе|
|**ADM‑ANS‑03**|`PUT answer` — нельзя превысить 5 ответов|

---

## 12. Аналитика и отчёты

|№|Тест|
|---|---|
|**ANL‑01**|`GET /api/admin/analytics/overview/` — содержит ключи `total_users`, `active_flows`, `avg_completion`|
|**ANL‑02**|`GET .../flows/` — фильтр по `flow_id`, корректные метрики времени|
|**ANL‑03**|`GET reports/completion/` — CSV/JSON формат соответствует спеке|
|**ANL‑04**|Доступ не‑модератора → 403|

---

## 13. Webhook / Bot

|№|Тест|
|---|---|
|**BOT‑01**|`POST /api/webhook/telegram/` — 200 при валидном апдейте|
|**BOT‑02**|Webhook с неподписанным телом → 401|
|**BOT‑03**|Неизвестный тип события → 204 (ignored)|
|**BOT‑04**|`GET /api/bot/user/{telegram_id}/` — существующий пользователь → 200|
|**BOT‑05**|Неизвестный `telegram_id` → 404|

---

## 14. Модели/БД (юнит‑тесты уровня ORM)

|№|Тест|
|---|---|
|**DB‑01**|`User.telegram_id` уникален, попытка дублирования → IntegrityError|
|**DB‑02**|При удалении Flow каскад не удаляет `Article` (shared)|
|**DB‑03**|Сигнал: при создании `UserRole` → автоматически `assigned_at` ставится|
|**DB‑04**|Property `is_accessible` вычисляется верно для комбинаций статусов|

---

## 15. Безопасность & устойчивость

|№|Тест|
|---|---|
|**SEC‑01**|JWT с изменённым `alg` блокируется|
|**SEC‑02**|Rate‑limit (например 60 req/min) возвращает 429|
|**SEC‑03**|Mass‑assignment: лишние поля в POST игнорируются, не сохраняются|
|**SEC‑04**|SQL‑инъекция в query‑param приводит к 400, не к ошибке сервера|
|**SEC‑05**|Параллельные `pause` + `resume` → консистентное конечное состояние|

---

## 16. Производительность (необязательно CI, но полезно)

|№|Тест|
|---|---|
|**PERF‑01**|`/api/my/flows/` отвечает < 200 мс при 1k flows на пользователя|
|**PERF‑02**|Webhook обработка < 100 мс среднее (cold DB в mock)|

---

### Как пользоваться

- **Позитивные/негативные сценарии** — отдельные ID или параметризация.
    
- **Форматы ответа** — проверяем ключи, типы, общее количество элементов.
    
- **Фикстуры**: пользователи c ролями (_user_, _buddy_, _moderator_), разные статусы Flow/Step.
    
- **Параллельные тесты**: рекомендовано для `SEC‑05`.
    

Этого списка достаточно, чтобы сгенерировать полноценный набор автотестов и покрыть функционал, ролевую модель, валидации, бизнес‑правила, безопасность и базовую производительность.

### Проверка покрытия

Запуск тестов с оценкой покрытия:

```bash
pytest --cov=apps --cov-report=term-missing --cov-report=html
```

HTML-отчёт появится в папке `htmlcov/`.