# Архитектура системы онбординга

## Структура приложений

### apps/users
- **models.py**: User, Role (роли теперь через ManyToMany)
- **serializers.py**: Сериализаторы пользователей
- **views.py**: API для авторизации и управления пользователями

### apps/flows
- **models.py**: Flow, FlowStep, UserFlow, UserStepProgress
- **services.py**: Бизнес-логика для работы с потоками
- **snapshot_models.py**: Модели снапшотов для сохранения состояния контента
- **views.py**: API endpoints
- **serializers.py**: Сериализаторы с логикой отображения

### apps/guides
- **models.py**: Article, ArticleCategory
- **views.py**: API для работы со статьями

## Основные принципы

1. **Снапшоты**: При прохождении контента создаются снапшоты для сохранения состояния
2. **Роли**: Простая система через ManyToMany без промежуточной таблицы
3. **Сервисный слой**: Вся бизнес-логика вынесена в services.py
4. **Прогрессивное раскрытие**: Пользователи видят только доступные этапы

## API структура

- `/api/my/` - личный кабинет пользователя
- `/api/flows/` - публичные потоки
- `/api/buddy/` - функционал для бадди
- `/api/admin/` - административные функции

## Модели данных

### User
- Основная модель пользователя
- Роли через ManyToMany к Role
- Интеграция с Telegram

### Flow
- Поток обучения
- Содержит этапы (FlowStep)
- Может быть назначен пользователю (UserFlow)

### FlowStep
- Этап потока
- Может содержать статью, задание или квиз
- Имеет порядок и статус

### UserStepProgress
- Прогресс пользователя по этапу
- Содержит снапшоты контента
- Отслеживает статус прохождения

## Бизнес-логика

### FlowService
- Запуск потока для пользователя
- Завершение этапов
- Создание снапшотов

### FlowProgressService
- Расчет прогресса
- Разблокировка этапов
- Управление статусами

## Безопасность

1. **Роли и права**:
   - user: базовый доступ
   - buddy: управление подопечными
   - moderator: полный доступ

2. **Проверки доступа**:
   - CanAccessFlowStep
   - CanManageFlow
   - IsBuddyOrModerator

3. **Telegram интеграция**:
   - Валидация данных
   - Безопасные сессии

## Тестирование

1. **Модульные тесты**:
   - Тесты моделей
   - Тесты сервисов
   - Тесты сериализаторов

2. **Интеграционные тесты**:
   - Тесты API
   - Тесты бизнес-процессов

3. **E2E тесты**:
   - Тесты пользовательских сценариев
   - Тесты Telegram интеграции 